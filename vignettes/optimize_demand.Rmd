---
title: "Optimize demand"
output: html_document
---

```{r setup, echo=FALSE}
library(flextools)
library(dplyr)
library(lubridate)
library(dygraphs)

# Import data
demo_energy_flows <- readxl::read_excel("energy_flows.xlsx") %>% 
  mutate(datetime = with_tz(datetime, "Europe/Amsterdam"))
year(demo_energy_flows$datetime) <- 2019
dttm_seq <- demo_energy_flows$datetime

# Add one extra day at the beginning and the end to not cut optmization in the plots
demo_energy_flows_first_day <- demo_energy_flows %>% filter(date(datetime) == min(date(datetime)))
day(demo_energy_flows_first_day$datetime) <- day(min(date(demo_energy_flows$datetime)))-1
demo_energy_flows_last_day <- demo_energy_flows %>% filter(date(datetime) == max(date(datetime)))
day(demo_energy_flows_last_day$datetime) <- day(max(date(demo_energy_flows$datetime)))+1
demo_energy_flows <- bind_rows(demo_energy_flows_first_day, demo_energy_flows, demo_energy_flows_last_day)
```

The `flextools` function `optimize_demand` provides a framework to modify a time-series demand profile according to different parameters, such as:

* **Contextual variables** for the optimization problem (local energy generation, static load, grid capacity, etc.). These values must be collected in a data frame through the `opt_data` parameter.
* **Optimization objective**, whether to minimize the net power or the energy cost.
* **Direction to shift energy** (forwards or backwards)
* **Time horizon** of the energy shift, being the maximum number of time-slots to shift demand from
* **Optimization window** characteristics, such as the length (in days), the starting hour or the hours where energy shifting is allowed.
* **Penalty on change** for the flexible load (parameter `lambda`). The higher lambda, the lower flexibility potential.

This article shows different configurations regarding these parameters, using the following example data set with a power demand and solar generation profiles:

```{r bau energy flows, fig.height=3, fig.align='center'}
demo_energy_flows %>% 
  dygraph(ylab = "Power (kW)") %>% 
  dySeries("solar", label = "Solar", color = "orange") %>% 
  dySeries("demand", label = "Demand", color = "navy") %>% 
  dyOptions(fillGraph = T)
```



