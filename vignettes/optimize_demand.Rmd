---
title: "Optimize demand"
output: html_document
---

```{r setup, echo=FALSE}
library(flextools)
library(dplyr)
library(lubridate)
library(dygraphs)

# Import data
demo_energy_flows <- readxl::read_excel("energy_flows.xlsx") %>% 
  mutate(datetime = with_tz(datetime, "Europe/Amsterdam")) 
  # add_extra_days()
year(demo_energy_flows$datetime) <- 2019
```

The `flextools` function `optimize_demand` provides a framework to modify a time-series demand profile according to different parameters, such as:

* **Contextual variables** for the optimization problem (local energy generation, static load, grid capacity, etc.). These values must be collected in a data frame through the `opt_data` parameter.
* **Optimization objective**, whether to minimize the net power or the energy cost.
* **Direction to shift energy** (forwards or backwards)
* **Time horizon** of the energy shift, being the maximum number of time-slots to shift demand from
* **Optimization window** characteristics, such as the length (in days), the starting hour or the hours where energy shifting is allowed.
* **Penalty on change** for the flexible load (parameter `lambda`). The higher lambda, the lower flexibility potential.

This article shows different configurations regarding these parameters, using the following example data set with a power demand and solar generation profiles:

```{r}
head(demo_energy_flows)
```


```{r bau energy flows, fig.height=3, fig.align='center'}
demo_energy_flows %>% 
  dygraph(ylab = "Power (kW)") %>% 
  dySeries("solar", label = "Solar", color = "orange") %>% 
  dySeries("demand", label = "Demand", color = "navy") %>% 
  dyOptions(fillGraph = T)
```


The first parameter in `optimize_demand()` function is `opt_data`. This parameter must be a tibble with the first column named `datetime`, containing the date-time sequence where the optimization algorithm is applied, and the second column named `flexible`, being the power profile of the flexible demand. Other variables that can be part of the `opt_data` algorithm are described in the function's reference page (see `optimize_demand()`).

In this case, we will rename the `demand` and `solar` variables from the `demo_energy_flows` object

```{r}
opt_data <- demo_energy_flows %>% 
  rename(
    flexible = demand,
    production = solar
  )
```



```{r}
optimize_demand(
  opt_data = opt_data,
  opt_objective = "grid",
  direction = "forward"
)
```












