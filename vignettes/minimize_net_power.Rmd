---
title: "Net power minimization"
output: html_document
---

Functions `optimize_demand` or `smart_charging` make use of Quadratic programming in order to obtain the optimal power load given certain conditions. The Quadratic programming problem can be formulated according to multiple objectives. Currently flextools package allows to optimize a time-series power load considering two different goals:

* Minimize the power exchanged with the grid (net power)
* Minimize the energy cost

In this article, we'll cover the optimization problem for the first objective: **net power minimization**.


# Problem formulation

Our **net power minimization** algorithm has been designed with multiple objectives:

1. Minimize the energy exchanged with the distribution grid maximizing the use of local generation
2. Obtain a demand profile the most flat as possible (peak shaving)

Like all optimization problems, an optimization process requires to formulate the problem and then find the proper optimization algorithm to solve this formulation. In this case, since the problem resulted to have quadratic terms, a Quadratic Programming algorithm has been used to solve it.
  
The objective function (Equation \@ref(eq:opt-objective)) and constraints (Equations \@ref(eq:opt-constraint-energy) - \@ref(eq:opt-constraint-identity-backward)) of this optimization problem are represented below, where:

- $T$ : Number of time intervals within the optimization window
- $G_t$ : Local power generation time-series vector
- $LS_t$ : Non-flexible load time-series vector
- $LF_t$ : Flexible load time-series vector (if not optimized)
- $O_t$ : Optimal flexible load time-series vector
- $\lambda$ : penalty on change for the flexible load
- $LFmax$ : Maximum power demand for the flexible load
- $GC_t$ : Grid power capacity time-series vector

\begin{equation}
  min \sum_{t=1}^{T} (R_t-L_t-O_t)^2 + \lambda (O_t-LF_t)^{2}
  (\#eq:opt-objective)
\end{equation}


Moreover, this energy optimization problem has the following constraints:
<!-- Equations \@ref(eq:opt-constraint-energy) and \@ref(eq:opt-constraint-limits) -->
  
* The energy consumed by the flexible load must remain the same than the expected behavior:

\begin{equation}
  \sum_{t=1}^T O_t \Delta t = \sum_{t=1}^T LF_t \Delta t
  (\#eq:opt-constraint-energy)
\end{equation}

* Optimal flexible load must be lower than a certain maximum power:

\begin{equation}
  0 \le O_t \le LFmax_t \quad t \in T
  (\#eq:opt-constraint-limits)
\end{equation}

* The energy balance between generation and loads must be lower than the grid capacity:

\begin{equation}
  0 \le O_t \le GC_t + G_t - LS_t \quad t \in T
  (\#eq:opt-constraint-limits)
\end{equation}


At the same time, we can optimize the flexible energy demand with two opposite approaches:

a. Postpone the consumption to later time-slots (shift the energy *forward*)
b. Consume now (store) the energy that will be consumed later (shift the energy *backward*)

We consider both approaches for different objectives or applications. The energy shift is always done within a maximum **time horizon** ($h$) to consider realistic scenarios. For example, the time horizon for the energy demand of a water boiler could have a time horizon of 6 hours, because it wouldn't make sense to heat the water more than 6 hours before the final consumption. Each one of these approaches brings extra constraints to the optimization problem:

If the energy can only be shifted **forward**:

* The cumulative sum of the optimal load $O$ must be higher than the cumulative sum of the original flexible load $LF$ except the last $h$ time slots, and lower than the total cumulative sum of the original flexible load $LF$ (energy can only be shifted forwards):
    
\begin{equation}
  \sum_{t = 1}^{u-h} LF_t \le \sum_{t=1}^u O_t \le \sum_{t=1}^u LF_t \quad u = 1 \dots T
  (\#eq:opt-constraint-cumsum-forward)
\end{equation}

* The maximum values for the optimal demand $O_t$ will depend on the time horizon $h$:

\begin{equation}
  O_u \le \sum_{t = u-h}^u LF_t \quad u = 1 \dots T
  (\#eq:opt-constraint-identity-forward)
\end{equation} 


If the energy can only be shifted **backward**:

* The cumulative sum of the optimal demand $O$ must be higher than the total cumulative sum of the original demand $LF$ (energy can only be shifted backwards), and lower than the cumulative sum of the original demand $LF$ except the following $h$ time slots:
    
\begin{equation}
  \sum_{t=1}^u LF_t \le \sum_{t=1}^u O_t \le \sum_{t=1}^{u+h} LF_t \quad u = 1 \dots T
  (\#eq:opt-constraint-cumsum-backward)
\end{equation}

* The maximum values for the optimal demand $O_t$ will depend on the time horizon $h$:

\begin{equation}
  O_u \le \sum_{t = u}^{u+h} LF_t \quad u = 1 \dots T
  (\#eq:opt-constraint-identity-backward)
\end{equation}


# Quadratic programming
  
Considering that the objective function of this problem (Equation \@ref(eq:opt-objective)) has quadratic terms, a Quadratic Programming algorithm must be used. In this case we have used the R package {osqp}, visit their [website](https://osqp.org/) for more information.

The form of a [quadratic problem](https://osqp.org/docs/solver/index.html) is:

\begin{equation}
  \begin{array}{ll} 
  \text{minimize} & \mathrm (1/2) x^\top \mathrm P \, \mathrm x + \mathrm q^{\top} \mathrm x \\ 
  \text{subject to} & \mathrm G \mathrm x \leq \mathrm h \\
                    & \mathrm A \mathrm x = \mathrm b 
  \end{array}
  (\#eq:cvx-formulation)
\end{equation}

The OSQP function `osqp::solve_osqp(P, q, A, l, u)` requires the parameters `P`, `q`, `A`, `l` and `u`. These parameters must be extracted from our problem formulation, so developing the objective function in Equation \@ref(eq:opt-objective) we can create `P` and `q` and from constraints \@ref(eq:opt-constraint-energy), \@ref(eq:opt-constraint-limits), \@ref(eq:opt-constraint-cumsum-forward), \@ref(eq:opt-constraint-identity-forward), \@ref(eq:opt-constraint-cumsum-backward) and \@ref(eq:opt-constraint-identity-backward) we can create `A`, `l` and `u`.

The theoretical expressions from the problem definition are translated to the function's required parameters using arrays and vectors. To illustrate this step, some equations are presented in the form of arrays considering a number of time slots of $T=8$ and a time horizon of $h=3$.

Equation \@ref(eq:opt-constraint-cumsum-forward):
\begin{equation}
\sum_{t = 1}^{u-3} LF_t \le \sum_{t=1}^u O_t \le \sum_{t=1}^u LF_t \quad u = 1 \dots 8

\\

\begin{bmatrix}
0 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\
0 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\
0 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\
1 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\
1 & 1 & 0 & 0 & 0 & 0 & 0 & 0\\
1 & 1 & 1 & 0 & 0 & 0 & 0 & 0\\
1 & 1 & 1 & 1 & 0 & 0 & 0 & 0\\
1 & 1 & 1 & 1 & 1 & 0 & 0 & 0\\
\end{bmatrix}
\times
\begin{bmatrix}
LF_1\\
LF_2\\
LF_3\\
LF_4\\
LF_5\\
LF_6\\
LF_7\\
LF_8
\end{bmatrix}

\le

\begin{bmatrix}
1 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\
1 & 1 & 0 & 0 & 0 & 0 & 0 & 0\\
1 & 1 & 1 & 0 & 0 & 0 & 0 & 0\\
1 & 1 & 1 & 1 & 0 & 0 & 0 & 0\\
1 & 1 & 1 & 1 & 1 & 0 & 0 & 0\\
1 & 1 & 1 & 1 & 1 & 1 & 0 & 0\\
1 & 1 & 1 & 1 & 1 & 1 & 1 & 0\\
1 & 1 & 1 & 1 & 1 & 1 & 1 & 1\\
\end{bmatrix}
\times
\begin{bmatrix}
O_1\\
O_2\\
O_3\\
O_4\\
O_5\\
O_6\\
O_7\\
O_8
\end{bmatrix}

\le

\begin{bmatrix}
1 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\
1 & 1 & 0 & 0 & 0 & 0 & 0 & 0\\
1 & 1 & 1 & 0 & 0 & 0 & 0 & 0\\
1 & 1 & 1 & 1 & 0 & 0 & 0 & 0\\
1 & 1 & 1 & 1 & 1 & 0 & 0 & 0\\
1 & 1 & 1 & 1 & 1 & 1 & 0 & 0\\
1 & 1 & 1 & 1 & 1 & 1 & 1 & 0\\
1 & 1 & 1 & 1 & 1 & 1 & 1 & 1\\
\end{bmatrix}
\times
\begin{bmatrix}
LF_1\\
LF_2\\
LF_3\\
LF_4\\
LF_5\\
LF_6\\
LF_7\\
LF_8
\end{bmatrix}
\end{equation}


Equation \@ref(eq:opt-constraint-identity-forward):
\begin{equation}
O_u \le \sum_{t = u - 3}^u LF_t \quad u = 1 \dots 8

\\

\begin{bmatrix}
1 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\
0 & 1 & 0 & 0 & 0 & 0 & 0 & 0\\
0 & 0 & 1 & 0 & 0 & 0 & 0 & 0\\
0 & 0 & 0 & 1 & 0 & 0 & 0 & 0\\
0 & 0 & 0 & 0 & 1 & 0 & 0 & 0\\
0 & 0 & 0 & 0 & 0 & 1 & 0 & 0\\
0 & 0 & 0 & 0 & 0 & 0 & 1 & 0\\
0 & 0 & 0 & 0 & 0 & 0 & 0 & 1\\
\end{bmatrix}
\times
\begin{bmatrix}
O_1\\
O_2\\
O_3\\
O_4\\
O_5\\
O_6\\
O_7\\
O_8
\end{bmatrix}
\le
\begin{bmatrix}
1 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\
1 & 1 & 0 & 0 & 0 & 0 & 0 & 0\\
1 & 1 & 1 & 0 & 0 & 0 & 0 & 0\\
1 & 1 & 1 & 1 & 0 & 0 & 0 & 0\\
0 & 1 & 1 & 1 & 1 & 0 & 0 & 0\\
0 & 0 & 1 & 1 & 1 & 1 & 0 & 0\\
0 & 0 & 0 & 1 & 1 & 1 & 1 & 0\\
0 & 0 & 0 & 0 & 1 & 1 & 1 & 1\\
\end{bmatrix}
\times
\begin{bmatrix}
LF_1\\
LF_2\\
LF_3\\
LF_4\\
LF_5\\
LF_6\\
LF_7\\
LF_8
\end{bmatrix}
\end{equation}



Equation \@ref(eq:opt-constraint-cumsum-backward):

\begin{equation}
\sum_{t=1}^u LF_t \le \sum_{t=1}^u O_t \le \sum_{t=1}^{u+3} LF_t \quad u = 1 \dots 8

\\

\begin{bmatrix}
1 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\
1 & 1 & 0 & 0 & 0 & 0 & 0 & 0\\
1 & 1 & 1 & 0 & 0 & 0 & 0 & 0\\
1 & 1 & 1 & 1 & 0 & 0 & 0 & 0\\
1 & 1 & 1 & 1 & 1 & 0 & 0 & 0\\
1 & 1 & 1 & 1 & 1 & 1 & 0 & 0\\
1 & 1 & 1 & 1 & 1 & 1 & 1 & 0\\
1 & 1 & 1 & 1 & 1 & 1 & 1 & 1\\
\end{bmatrix}
\times
\begin{bmatrix}
LF_1\\
LF_2\\
LF_3\\
LF_4\\
LF_5\\
LF_6\\
LF_7\\
LF_8
\end{bmatrix}

\le

\begin{bmatrix}
1 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\
1 & 1 & 0 & 0 & 0 & 0 & 0 & 0\\
1 & 1 & 1 & 0 & 0 & 0 & 0 & 0\\
1 & 1 & 1 & 1 & 0 & 0 & 0 & 0\\
1 & 1 & 1 & 1 & 1 & 0 & 0 & 0\\
1 & 1 & 1 & 1 & 1 & 1 & 0 & 0\\
1 & 1 & 1 & 1 & 1 & 1 & 1 & 0\\
1 & 1 & 1 & 1 & 1 & 1 & 1 & 1\\
\end{bmatrix}
\times
\begin{bmatrix}
O_1\\
O_2\\
O_3\\
O_4\\
O_5\\
O_6\\
O_7\\
O_8
\end{bmatrix}

\le

\begin{bmatrix}
1 & 1 & 1 & 1 & 0 & 0 & 0 & 0\\
1 & 1 & 1 & 1 & 1 & 0 & 0 & 0\\
1 & 1 & 1 & 1 & 1 & 1 & 0 & 0\\
1 & 1 & 1 & 1 & 1 & 1 & 1 & 0\\
1 & 1 & 1 & 1 & 1 & 1 & 1 & 1\\
1 & 1 & 1 & 1 & 1 & 1 & 1 & 1\\
1 & 1 & 1 & 1 & 1 & 1 & 1 & 1\\
1 & 1 & 1 & 1 & 1 & 1 & 1 & 1\\
\end{bmatrix}
\times
\begin{bmatrix}
LF_1\\
LF_2\\
LF_3\\
LF_4\\
LF_5\\
LF_6\\
LF_7\\
LF_8
\end{bmatrix}
\end{equation}


Equation \@ref(eq:opt-constraint-identity-backward):

\begin{equation}
O_u \le \sum_{t = u}^{u+3} LF_t \quad u = 1 \dots 8

\\

\begin{bmatrix}
1 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\
0 & 1 & 0 & 0 & 0 & 0 & 0 & 0\\
0 & 0 & 1 & 0 & 0 & 0 & 0 & 0\\
0 & 0 & 0 & 1 & 0 & 0 & 0 & 0\\
0 & 0 & 0 & 0 & 1 & 0 & 0 & 0\\
0 & 0 & 0 & 0 & 0 & 1 & 0 & 0\\
0 & 0 & 0 & 0 & 0 & 0 & 1 & 0\\
0 & 0 & 0 & 0 & 0 & 0 & 0 & 1\\
\end{bmatrix}
\times
\begin{bmatrix}
O_1\\
O_2\\
O_3\\
O_4\\
O_5\\
O_6\\
O_7\\
O_8
\end{bmatrix}
\le
\begin{bmatrix}
1 & 1 & 1 & 1 & 0 & 0 & 0 & 0\\
0 & 1 & 1 & 1 & 1 & 0 & 0 & 0\\
0 & 0 & 1 & 1 & 1 & 1 & 0 & 0\\
0 & 0 & 0 & 1 & 1 & 1 & 1 & 0\\
0 & 0 & 0 & 0 & 1 & 1 & 1 & 1\\
0 & 0 & 0 & 0 & 0 & 1 & 1 & 1\\
0 & 0 & 0 & 0 & 0 & 0 & 1 & 1\\
0 & 0 & 0 & 0 & 0 & 0 & 0 & 1\\
\end{bmatrix}
\times
\begin{bmatrix}
LF_1\\
LF_2\\
LF_3\\
LF_4\\
LF_5\\
LF_6\\
LF_7\\
LF_8
\end{bmatrix}
\end{equation}

